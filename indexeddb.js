"use strict";angular.module("xc.indexedDB",[]).provider("$indexedDB",function(){var e=this;e.dbName="",e.dbVersion=1,e.db=null,e.dbPromise=null,e.debugMode=!1,e.onTransactionComplete=function(t){e.debugMode&&console.log("Transaction completed.")},e.onTransactionAbort=function(t){e.debugMode&&console.log("Transaction aborted: "+(t.target.webkitErrorMessage||t.target.error.message||t.target.errorCode))},e.onTransactionError=function(t){e.debugMode&&console.log("Transaction failed: "+t.target.errorCode)},e.onDatabaseError=function(t){e.debugMode&&alert("Database error: "+(t.target.webkitErrorMessage||t.target.errorCode))},e.onDatabaseBlocked=function(t){e.debugMode&&alert("Database is blocked. Try close other tabs with this page open and reload this page!")},e.connection=function(t){return e.dbName=t,this},e.upgradeDatabase=function(t,n){return e.dbVersion=t,e.upgradeCallback=n,this},e.$get=["$q","$rootScope","$window",function(t,n,r){"indexedDB"in r||(r.indexedDB=r.mozIndexedDB||r.webkitIndexedDB||r.msIndexedDB);var o=r.IDBKeyRange||r.mozIDBKeyRange||r.webkitIDBKeyRange||r.msIDBKeyRange,i={useIndex:void 0,keyRange:null,direction:"next"},a=function(){var o,i;return e.dbPromise||(i=t.defer(),e.dbPromise=i.promise,(o=r.indexedDB.open(e.dbName,e.dbVersion||1)).onsuccess=function(t){e.db=o.result,n.$apply(function(){i.resolve(e.db)})},o.onblocked=e.onDatabaseBlocked,o.onerror=e.onDatabaseError,o.onupgradeneeded=function(t){var n=t.target.result,r=t.target.transaction;e.debugMode&&console.log('upgrading database "'+n.name+'" from version '+t.oldVersion+" to version "+t.newVersion+"..."),e.upgradeCallback&&e.upgradeCallback(t,n,r)}),e.dbPromise},s=function(e){this.storeName=e,this.transaction=void 0};s.prototype={internalObjectStore:function(t,n){var r=this;return a().then(function(o){return r.transaction=o.transaction([t],n||"readonly"),r.transaction.oncomplete=e.onTransactionComplete,r.transaction.onabort=e.onTransactionAbort,r.onerror=e.onTransactionError,r.transaction.objectStore(t)})},abort:function(){this.transaction&&this.transaction.abort()},insert:function(e){var r=t.defer();return this.internalObjectStore(this.storeName,"readwrite").then(function(t){var o;return angular.isArray(e)?e.forEach(function(i,a){(o=t.add(i)).onnotify=function(e){n.$apply(function(){r.notify(e.target.result)})},o.onerror=function(e){n.$apply(function(){r.reject(e.target.result)})},o.onsuccess=function(t){a==e.length-1&&n.$apply(function(){r.resolve(t.target.result)})}}):(o=t.add(e)).onsuccess=o.onerror=function(e){n.$apply(function(){r.resolve(e.target.result)})},r.promise})},upsert:function(e){var r=t.defer();return this.internalObjectStore(this.storeName,"readwrite").then(function(t){var o;return angular.isArray(e)?e.forEach(function(i,a){(o=t.put(i)).onnotify=function(e){n.$apply(function(){r.notify(e.target.result)})},o.onerror=function(e){n.$apply(function(){r.reject(e.target.result)})},o.onsuccess=function(t){a==e.length-1&&n.$apply(function(){r.resolve(t.target.result)})}}):(o=t.put(e)).onsuccess=o.onerror=function(e){n.$apply(function(){r.resolve(e.target.result)})},r.promise})},delete:function(e){var r=t.defer();return this.internalObjectStore(this.storeName,"readwrite").then(function(t){var o=t.delete(e);return o.onsuccess=o.onerror=function(e){n.$apply(function(){r.resolve(e.target.result)})},r.promise})},clear:function(){var e=t.defer();return this.internalObjectStore(this.storeName,"readwrite").then(function(t){var r=t.clear();return r.onsuccess=r.onerror=function(t){n.$apply(function(){e.resolve(t.target.result)})},e.promise})},count:function(){return this.internalObjectStore(this.storeName,"readonly").then(function(e){return e.count()})},find:function(e,r){var o=t.defer(),i=o.promise;return this.internalObjectStore(this.storeName,"readonly").then(function(t){var a;return a=r?t.index(e).get(r):t.get(e),a.onsuccess=a.onerror=function(e){n.$apply(function(){o.resolve(e.target.result)})},i})},getAll:function(){var e=[],r=t.defer();return this.internalObjectStore(this.storeName,"readonly").then(function(t){var o;return t.getAll?(o=t.getAll()).onsuccess=o.onerror=function(e){n.$apply(function(){r.resolve(e.target.result)})}:((o=t.openCursor()).onsuccess=function(t){var o=t.target.result;o?(e.push(o.value),o.continue()):n.$apply(function(){r.resolve(e)})},o.onerror=function(e){r.reject(e.target.result)}),r.promise})},each:function(e,r){var o=t.defer();return this.internalObjectStore(this.storeName,"readwrite").then(function(t){var a;return r=r||i,a=r.useIndex?t.index(r.useIndex).openCursor(r.keyRange,r.direction):t.openCursor(r.keyRange,r.direction),a.onsuccess=a.onerror=function(t){n.$apply(function(){t.target.result||o.resolve(t.target.result),e(t.target.result)})},o.promise})}};var u=function(){this.result=i};return u.prototype={$lt:function(e){return this.result.keyRange=o.upperBound(e,!0),this},$gt:function(e){return this.result.keyRange=o.lowerBound(e,!0),this},$lte:function(e){return this.result.keyRange=o.upperBound(e),this},$gte:function(e){return this.result.keyRange=o.lowerBound(e),this},$eq:function(e){return this.result.keyRange=o.only(e),this},$between:function(e,t,n,r){return this.result.keyRange=o.bound(e,t,n||!1,r||!1),this},$asc:function(e){return this.result.order=e?"nextunique":"next",this},$desc:function(e){return this.result.order=e?"prevunique":"prev",this},$index:function(e){return this.result.useIndex=e,this},compile:function(){return this.result}},{objectStore:function(e){return new s(e)},dbInfo:function(){var e,t,n,r=[];return a().then(function(o){return e=Array.prototype.slice.apply(o.objectStoreNames),t=o.transaction(e,"readonly"),e.forEach(function(e){n=t.objectStore(e),r.push({name:e,keyPath:n.keyPath,autoIncrement:n.autoIncrement,count:n.count(),indices:Array.prototype.slice.apply(n.indexNames)})}),{name:o.name,version:o.version,objectStores:r}})},closeDB:function(){return a().then(function(e){e.close()}),e.db=null,e.dbPromise=null,this},switchDB:function(t,n,r){return this.closeDB(),e.dbName=t,e.dbVersion=n||1,e.upgradeCallback=r||function(){},this},queryBuilder:function(){return new u}}}]});
